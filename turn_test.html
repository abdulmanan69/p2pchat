<!DOCTYPE html>
<html>
<head>
    <title>TURN Server Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; background: #4a6fa5; color: white; border: none; cursor: pointer; }
        button:hover { background: #3a5a80; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        textarea { width: 100%; height: 150px; font-family: monospace; margin-top: 10px; }
        .log { height: 200px; overflow-y: auto; font-family: monospace; background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <h1>TURN Server Test</h1>
    
    <div class="test-section">
        <h2>Cloudflare TURN Credentials</h2>
        <button id="fetchTurn">Fetch TURN Credentials</button>
        <div id="turnResult" class="result"></div>
        <textarea id="turnDetails" placeholder="TURN server details will appear here"></textarea>
    </div>
    
    <div class="test-section">
        <h2>TURN Connectivity Test</h2>
        <button id="testTurn">Test TURN Connectivity</button>
        <div id="connectivityResult" class="result"></div>
        <div id="connectivityLog" class="log" style="display:none;"></div>
    </div>
    
    <div class="test-section">
        <h2>Specific Cloudflare TURN Test</h2>
        <button id="testSpecificTurn">Test Specific TURN Server</button>
        <div id="specificTurnResult" class="result"></div>
        <textarea id="specificTurnDetails" placeholder="Specific TURN test details will appear here"></textarea>
    </div>
    
    <div class="test-section">
        <h2>ICE Candidate Analysis</h2>
        <button id="analyzeIce">Analyze ICE Candidates</button>
        <div id="iceResult" class="result"></div>
        <textarea id="iceDetails" placeholder="ICE candidate details will appear here"></textarea>
    </div>

    <script src="turn_helper.js"></script>
    <script>
        document.getElementById('fetchTurn').addEventListener('click', fetchTurnCredentials);
        document.getElementById('testTurn').addEventListener('click', testTurnConnectivity);
        document.getElementById('testSpecificTurn').addEventListener('click', testSpecificTurnServer);
        document.getElementById('analyzeIce').addEventListener('click', analyzeIceCandidates);
        
        // Console log capture
        const originalLog = console.log;
        const logDiv = document.getElementById('connectivityLog');
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (logDiv.style.display !== 'none') {
                const timestamp = new Date().toLocaleTimeString();
                logDiv.innerHTML += `[${timestamp}] ${args.join(' ')}\n`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        };
        
        async function fetchTurnCredentials() {
            const result = document.getElementById('turnResult');
            const details = document.getElementById('turnDetails');
            
            result.innerHTML = 'Fetching TURN credentials...';
            result.className = 'result';
            details.value = '';
            
            try {
                const iceServers = await TurnHelper.getTurnCredentials();
                
                result.innerHTML = '✅ TURN credentials fetched successfully';
                result.className = 'result success';
                
                details.value = JSON.stringify(iceServers, null, 2);
            } catch (error) {
                result.innerHTML = `❌ Error fetching TURN credentials: ${error.message}`;
                result.className = 'result error';
            }
        }
        
        async function testTurnConnectivity() {
            const result = document.getElementById('connectivityResult');
            const log = document.getElementById('connectivityLog');
            
            result.innerHTML = 'Testing TURN connectivity...';
            result.className = 'result';
            log.style.display = 'block';
            log.innerHTML = '';
            
            try {
                const testResults = await TurnHelper.testTurnConnectivity();
                
                if (testResults.error) {
                    result.innerHTML = `❌ TURN connectivity test failed: ${testResults.error}`;
                    result.className = 'result error';
                    return;
                }
                
                // Display results
                let statusText = `✅ TURN connectivity test completed<br>`;
                statusText += `ICE Servers: ${testResults.iceServers.length}<br>`;
                statusText += `Candidates Generated: ${testResults.candidates.length}<br>`;
                
                if (testResults.candidates.length > 0) {
                    statusText += '<br>Candidate Types:<br>';
                    for (const [type, count] of Object.entries(testResults.candidateTypes)) {
                        statusText += `&nbsp;&nbsp;${type}: ${count}<br>`;
                    }
                }
                
                statusText += '<br>Connection States:<br>';
                for (const state of testResults.states) {
                    statusText += `&nbsp;&nbsp;${state.time.split('T')[1].split('.')[0]}: ${state.state}<br>`;
                }
                
                result.innerHTML = statusText;
                result.className = testResults.candidates.length > 0 ? 'result success' : 'result warning';
                
            } catch (error) {
                result.innerHTML = `❌ Error testing TURN connectivity: ${error.message}`;
                result.className = 'result error';
            }
        }
        
        async function testSpecificTurnServer() {
            const result = document.getElementById('specificTurnResult');
            const details = document.getElementById('specificTurnDetails');
            
            result.innerHTML = 'Testing specific Cloudflare TURN server...';
            result.className = 'result';
            details.value = '';
            
            try {
                const testResults = await TurnHelper.testSpecificTurnServer();
                
                if (testResults.error) {
                    result.innerHTML = `❌ Specific TURN server test failed: ${testResults.error}`;
                    result.className = 'result error';
                    return;
                }
                
                // Display results
                let statusText = `✅ Specific TURN server test completed<br>`;
                statusText += `Candidates Generated: ${testResults.candidates.length}<br>`;
                
                if (testResults.candidates.length > 0) {
                    statusText += '<br>Candidate Types:<br>';
                    for (const [type, count] of Object.entries(testResults.candidateTypes)) {
                        statusText += `&nbsp;&nbsp;${type}: ${count}<br>`;
                    }
                    
                    statusText += '<br>Sample Candidates:<br>';
                    testResults.candidates.slice(0, 3).forEach((candidate, index) => {
                        statusText += `&nbsp;&nbsp;${index + 1}. ${candidate.type}: ${candidate.protocol || 'N/A'}<br>`;
                    });
                } else {
                    statusText += '<br>⚠️ No ICE candidates generated. This might indicate:<br>';
                    statusText += '&nbsp;&nbsp;• Network/firewall restrictions<br>';
                    statusText += '&nbsp;&nbsp;• TURN server connectivity issues<br>';
                    statusText += '&nbsp;&nbsp;• Incorrect TURN credentials<br>';
                }
                
                statusText += '<br>Connection States:<br>';
                for (const state of testResults.states) {
                    statusText += `&nbsp;&nbsp;${state.time.split('T')[1].split('.')[0]}: ${state.state}<br>`;
                }
                
                result.innerHTML = statusText;
                result.className = testResults.candidates.length > 0 ? 'result success' : 'result warning';
                
                // Add candidate details to textarea
                if (testResults.candidates.length > 0) {
                    details.value = 'ICE Candidates:\n';
                    testResults.candidates.forEach((candidate, index) => {
                        details.value += `${index + 1}. ${candidate.type}: ${candidate.candidate}\n`;
                    });
                }
                
            } catch (error) {
                result.innerHTML = `❌ Error testing specific TURN server: ${error.message}`;
                result.className = 'result error';
                details.value = `Error: ${error.message}`;
            }
        }
        
        async function analyzeIceCandidates() {
            const result = document.getElementById('iceResult');
            const details = document.getElementById('iceDetails');
            
            result.innerHTML = 'Analyzing ICE candidates...';
            result.className = 'result';
            details.value = '';
            
            try {
                const candidates = [];
                const candidateTypes = {};
                
                const iceServers = await TurnHelper.getTurnCredentials();
                const pc = new RTCPeerConnection({ iceServers });
                
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        candidates.push(event.candidate);
                        
                        // Categorize candidate types
                        const type = event.candidate.type;
                        candidateTypes[type] = (candidateTypes[type] || 0) + 1;
                        
                        result.innerHTML = `Generated ${candidates.length} ICE candidates...`;
                    } else if (candidates.length > 0) {
                        result.innerHTML = `✅ Successfully generated ${candidates.length} ICE candidates<br>`;
                        
                        // Show candidate type breakdown
                        for (const [type, count] of Object.entries(candidateTypes)) {
                            result.innerHTML += `${type}: ${count}<br>`;
                        }
                        
                        result.className = 'result success';
                        details.value = candidates.map(c => `${c.type}: ${c.address || c.candidate}`).join('\n');
                    }
                };
                
                // Create a dummy data channel to trigger ICE
                const dataChannel = pc.createDataChannel('test');
                
                // Create offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                // Timeout after 8 seconds (increased from 5)
                setTimeout(() => {
                    if (candidates.length === 0) {
                        result.innerHTML = '⚠️ No ICE candidates generated within 8 seconds. This might indicate network issues.';
                        result.className = 'result warning';
                        
                        // Show what ICE servers we tried
                        const serverInfo = iceServers.map(server => 
                            Array.isArray(server.urls) ? server.urls.join(', ') : server.urls
                        ).join('\n');
                        details.value = `Attempted ICE servers:\n${serverInfo}\n\nNo candidates generated.`;
                    }
                    pc.close();
                }, 8000);
                
            } catch (error) {
                result.innerHTML = `❌ Error analyzing ICE candidates: ${error.message}`;
                result.className = 'result error';
            }
        }
    </script>
</body>
</html>